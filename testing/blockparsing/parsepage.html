<!DOCTYPE html>
<html>

<head>
    <title>Parse Blockly Into Page</title>
    <!-- Theme Color -->
    <meta name="theme-color" content="darkslategrey">
    <!-- Manifest JSON -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    <!-- Mobile Capable -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Favicon -->
    <!-- <link rel="icon" href="./static/creeperface.jpg"> -->
    <!-- Scale & Device Width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <style>
    h1 {
        color: darkslategrey;
    }
    </style>
</head>

<body>
    <xml type="project_xml" id="blockly_xml" style="display:none;" xmlns="http://www.w3.org/1999/xhtml">
        <block type="css_file" id="[SLqO=Lp%PRG*pNP9MEr" collapsed="true" x="0" y="0">
            <field name="file_name">theme</field>
            <statement name="rules">
                <block type="css_rule" id="4rqq*oXJ6Akyw$RC)0G0">
                    <field name="rule">h1, h4;</field>
                    <statement name="properties">
                        <block type="css_property" id=",YePf=B~bTMcZ/}EMjY0">
                            <field name="property">color</field>
                            <field name="name">darkslategrey</field>
                        </block>
                    </statement>
                    <next>
                        <block type="css_rule" id="(DM@d6u_IM%TNxA+Jb]3">
                            <field name="rule">li</field>
                            <statement name="properties">
                                <block type="css_property" id="R8C@TU?,))L+Z46$M(2@">
                                    <field name="property">color</field>
                                    <field name="name">olive</field>
                                </block>
                            </statement>
                        </block>
                    </next>
                </block>
            </statement>
        </block>
        <block type="boiler_page" id="~cJ](jF(LS3jY5W@+N?5" collapsed="true" x="0" y="52">
            <field name="name">about</field>
            <statement name="inner">
                <block type="is_home" id="}rfbLUN+!R2s7M1*8WX?">
                    <field name="value">TRUE</field>
                    <next>
                        <block type="css_include" id="7VB}|j=}37n8}utP/U?G">
                            <field name="file_name">theme</field>
                            <next>
                                <block type="h1" id="[2c{atdwT+`$XXe@XjM%">
                                    <statement name="innerHtml">
                                        <block type="html_text" id="bsY=4q8wAi^:Ev.JwG0m">
                                            <field name="value">Company: About Us</field>
                                        </block>
                                    </statement>
                                    <next>
                                        <block type="p" id="EnyDH=oQ#JE/dvYZ!K-:">
                                            <statement name="innerHtml">
                                                <block type="html_text" id="hVh{(|u`$tB0;U;UxL5l">
                                                    <field name="value"> Zombie ipsum reversus ab viral inferno, nam rick grimes malum cerebro. De carne lumbering animata corpora quaeritis. Summus brains sit​​, morbo vel maleficia? De apocalypsi gorger omero undead survivor dictum mauris. Hi mindless mortuis soulless creaturas, imo evil stalking monstra adventus resi dentevil vultus comedat cerebella viventium. Qui animated corpse, cricket bat max brucks terribilem incessu zomby. The voodoo sacerdos flesh eater, suscitat mortuos comedere carnem virus. Zonbi tattered for solum oculi eorum defunctis go lum cerebro. Nescio brains an Undead zombies. Sicut malus putrid voodoo horror. Nigh tofth eliv ingdead.</field>
                                                </block>
                                            </statement>
                                        </block>
                                    </next>
                                </block>
                            </next>
                        </block>
                    </next>
                </block>
            </statement>
        </block>
        <block type="boiler_page" id="4[Af;)Z3YhQ%Gcutq(9:" x="0" y="104">
            <field name="name">pagetwo</field>
            <statement name="inner">
                <block type="css_include" id="~xEsYV#|fenizQwG{{S1">
                    <field name="file_name">theme</field>
                    <next>
                        <block type="h4" id="EN6D_V6ERgs01k,zTXl9">
                            <statement name="innerHtml">
                                <block type="html_text" id="6pQ93ZHqk({[}}!1O/In">
                                    <field name="value">Company: Page Two</field>
                                </block>
                            </statement>
                            <next>
                                <block type="a" id="%,bzh#itpC:Dql7,=f[Q">
                                    <statement name="innerHtml">
                                        <block type="attr" id="s9Tzp]!]8$]+*3k.%ZhZ">
                                            <field name="attr_name">href</field>
                                            <field name="attr_value">https://spaboilerplate2017.flaskcart.co/</field>
                                            <next>
                                                <block type="html_text" id=":#f[V-j}0W)$3;1NnwRr">
                                                    <field name="value">spaboilerplate2017.flaskcart.co</field>
                                                </block>
                                            </next>
                                        </block>
                                    </statement>
                                    <next>
                                        <block type="ol" id="o}?O6*Z.;Y2hq+p^gzNm">
                                            <statement name="innerHtml">
                                                <block type="li" id="DcX|X@q.od36{#*:hu6x">
                                                    <statement name="innerHtml">
                                                        <block type="html_text" id="UFR+IxTBE?Nv(.0,Gfmq">
                                                            <field name="value">first we do this</field>
                                                        </block>
                                                    </statement>
                                                    <next>
                                                        <block type="li" id="gk^H3N%;,,5b(8hYPOj,">
                                                            <statement name="innerHtml">
                                                                <block type="html_text" id="g0XRG;4$`dbSA(2mHx*!">
                                                                    <field name="value">then help with this</field>
                                                                </block>
                                                            </statement>
                                                            <next>
                                                                <block type="li" id="59NRLpQ[{3)+@[]iLsc_">
                                                                    <statement name="innerHtml">
                                                                        <block type="html_text" id="49cgNND]DPTo^jXK#4%$">
                                                                            <field name="value">and finally we do this</field>
                                                                        </block>
                                                                    </statement>
                                                                </block>
                                                            </next>
                                                        </block>
                                                    </next>
                                                </block>
                                            </statement>
                                        </block>
                                    </next>
                                </block>
                            </next>
                        </block>
                    </next>
                </block>
            </statement>
        </block>
    </xml>
    <h1>Welcome, Parsing Project XML now!</h1>
    <div id="output"></div>
    <script>
    var html_texts = [{
        "name": "!DOCTYPE",
        "info": ""
    }, {
        "name": "a",
        "info": ""
    }, {
        "name": "abbr",
        "info": ""
    }, {
        "name": "acronym",
        "info": ""
    }, {
        "name": "address",
        "info": ""
    }, {
        "name": "applet",
        "info": ""
    }, {
        "name": "area",
        "info": ""
    }, {
        "name": "article",
        "info": ""
    }, {
        "name": "aside",
        "info": ""
    }, {
        "name": "audio",
        "info": ""
    }, {
        "name": "b",
        "info": ""
    }, {
        "name": "base",
        "info": ""
    }, {
        "name": "basefont",
        "info": ""
    }, {
        "name": "bdi",
        "info": ""
    }, {
        "name": "bdo",
        "info": ""
    }, {
        "name": "big",
        "info": ""
    }, {
        "name": "blockquote",
        "info": ""
    }, {
        "name": "body",
        "info": ""
    }, {
        "name": "br",
        "info": ""
    }, {
        "name": "button",
        "info": ""
    }, {
        "name": "canvas",
        "info": ""
    }, {
        "name": "caption",
        "info": ""
    }, {
        "name": "center",
        "info": ""
    }, {
        "name": "cite",
        "info": ""
    }, {
        "name": "code",
        "info": ""
    }, {
        "name": "col",
        "info": ""
    }, {
        "name": "colgroup",
        "info": ""
    }, {
        "name": "datalist",
        "info": ""
    }, {
        "name": "dd",
        "info": ""
    }, {
        "name": "del",
        "info": ""
    }, {
        "name": "details",
        "info": ""
    }, {
        "name": "dfn",
        "info": ""
    }, {
        "name": "dialog",
        "info": ""
    }, {
        "name": "dir",
        "info": ""
    }, {
        "name": "div",
        "info": ""
    }, {
        "name": "dl",
        "info": ""
    }, {
        "name": "dt",
        "info": ""
    }, {
        "name": "em",
        "info": ""
    }, {
        "name": "embed",
        "info": ""
    }, {
        "name": "fieldset",
        "info": ""
    }, {
        "name": "figcaption",
        "info": ""
    }, {
        "name": "figure",
        "info": ""
    }, {
        "name": "font",
        "info": ""
    }, {
        "name": "footer",
        "info": ""
    }, {
        "name": "form",
        "info": ""
    }, {
        "name": "frame",
        "info": ""
    }, {
        "name": "frameset",
        "info": ""
    }, {
        "name": "h1",
        "info": ""
    }, {
        "name": "h2",
        "info": ""
    }, {
        "name": "h3",
        "info": ""
    }, {
        "name": "h4",
        "info": ""
    }, {
        "name": "h5",
        "info": ""
    }, {
        "name": "h6",
        "info": ""
    }, {
        "name": "head",
        "info": ""
    }, {
        "name": "header",
        "info": ""
    }, {
        "name": "hr",
        "info": ""
    }, {
        "name": "html",
        "info": ""
    }, {
        "name": "i",
        "info": ""
    }, {
        "name": "iframe",
        "info": ""
    }, {
        "name": "img",
        "info": ""
    }, {
        "name": "input",
        "info": ""
    }, {
        "name": "ins",
        "info": ""
    }, {
        "name": "kbd",
        "info": ""
    }, {
        "name": "keygen",
        "info": ""
    }, {
        "name": "label",
        "info": ""
    }, {
        "name": "legend",
        "info": ""
    }, {
        "name": "li",
        "info": ""
    }, {
        "name": "link",
        "info": ""
    }, {
        "name": "main",
        "info": ""
    }, {
        "name": "map",
        "info": ""
    }, {
        "name": "mark",
        "info": ""
    }, {
        "name": "menu",
        "info": ""
    }, {
        "name": "menuitem",
        "info": ""
    }, {
        "name": "meta",
        "info": ""
    }, {
        "name": "meter",
        "info": ""
    }, {
        "name": "nav",
        "info": ""
    }, {
        "name": "noframes",
        "info": ""
    }, {
        "name": "noscript",
        "info": ""
    }, {
        "name": "object",
        "info": ""
    }, {
        "name": "ol",
        "info": ""
    }, {
        "name": "optgroup",
        "info": ""
    }, {
        "name": "option",
        "info": ""
    }, {
        "name": "output",
        "info": ""
    }, {
        "name": "p",
        "info": ""
    }, {
        "name": "param",
        "info": ""
    }, {
        "name": "picture",
        "info": ""
    }, {
        "name": "pre",
        "info": ""
    }, {
        "name": "progress",
        "info": ""
    }, {
        "name": "q",
        "info": ""
    }, {
        "name": "rp",
        "info": ""
    }, {
        "name": "rt",
        "info": ""
    }, {
        "name": "ruby",
        "info": ""
    }, {
        "name": "s",
        "info": ""
    }, {
        "name": "samp",
        "info": ""
    }, {
        "name": "script",
        "info": ""
    }, {
        "name": "section",
        "info": ""
    }, {
        "name": "select",
        "info": ""
    }, {
        "name": "small",
        "info": ""
    }, {
        "name": "source",
        "info": ""
    }, {
        "name": "span",
        "info": ""
    }, {
        "name": "strike",
        "info": ""
    }, {
        "name": "strong",
        "info": ""
    }, {
        "name": "style",
        "info": ""
    }, {
        "name": "sub",
        "info": ""
    }, {
        "name": "summary",
        "info": ""
    }, {
        "name": "sup",
        "info": ""
    }, {
        "name": "table",
        "info": ""
    }, {
        "name": "tbody",
        "info": ""
    }, {
        "name": "td",
        "info": ""
    }, {
        "name": "textarea",
        "info": ""
    }, {
        "name": "tfoot",
        "info": ""
    }, {
        "name": "th",
        "info": ""
    }, {
        "name": "thead",
        "info": ""
    }, {
        "name": "time",
        "info": ""
    }, {
        "name": "title",
        "info": ""
    }, {
        "name": "tr",
        "info": ""
    }, {
        "name": "track",
        "info": ""
    }, {
        "name": "tt",
        "info": ""
    }, {
        "name": "u",
        "info": ""
    }, {
        "name": "ul",
        "info": ""
    }, {
        "name": "var",
        "info": ""
    }, {
        "name": "video",
        "info": ""
    }, {
        "name": "wbr",
        "info": ""
    }];


    function output(out) {
        $("#output").empty();
        $("#output").html(out);
    }

    function traverse_order(xml, selector) {
        var
            x,
            ar = []
            //
        ;
        $(xml).find(selector).each(function() {
            ar.push({
                length: $(this).parents().length,
                elmt: $(this)
            });
        });

        ar.sort(function(a, b) {
            if (a.length - b.length > 0) {
                return -1;
            }

            if (a.length - b.length < 0) {
                return 1;
            }

            return 0;
        });

        for (var i = 0; i < ar.length; i++) {
            x += (ar[i].elmt.attr("type")) + ' - ';
        };

        return {
            "list": ar,
            "string": x
        };
    }

    output(css);

    /*
        // Grab the html json
        window.html5_tags = null;
        $.getJSON("html5.json", function(result) {
            window.html5_tags = result;
        });
    */

    var css_xml = $("#blockly_xml").find('block[type="css_file"]');
    var pages_xml = $("#blockly_xml").find('block[type="boiler_page"]');
    var pages = [];
    var css = [];

    /**
     * Removal of nexts.
     * @return {[type]}
     */
    function parse_nexts() {
        nexts = traverse_order($("#blockly_xml"), "next");
        for (var i = 0; i < nexts["list"].length; i++) {
            var html = $(nexts["list"][i].elmt).html();
            $(nexts["list"][i].elmt).closest("block").after(html);
            $(nexts["list"][i].elmt).remove();
        }
    }

    /**
     * Removal of statement tags.
     * @return {[type]}
     */
    function parse_statements() {
        statements = traverse_order($("#blockly_xml"), "statement");
        for (var i = 0; i < statements["list"].length; i++) {
            var html = $(statements["list"][i].elmt).html();
            console.log(html);
            $(statements["list"][i].elmt).closest("block").append(html);
            $(statements["list"][i].elmt).remove();
        }
    }

    /**
     * Replacement of html_text.
     * @return {[type]}
     */
    function parse_html_texts() {
        texts = traverse_order($("#blockly_xml"), "block[type=html_text]")
        for (var i = 0; i < texts["list"].length; i++) {
            var html = $(texts["list"][i].elmt).find("field[name=value]").html();
            $(texts["list"][i].elmt).after(html)
            $(texts["list"][i].elmt).remove();
        }
    }

    /**
     * Replacement of HTML Tag blocks.
     * @return {[type]}
     */
    function parse_html_tags() {
        html_block_names = []
        for (var i = 0; i < html_texts.length; i++) {
            html_block_names.push(html_texts[i]["name"]);
        }
        blocks = traverse_order($("#blockly_xml"), "block");
        for (var i = 0; i < blocks["list"].length; i++) {
            block_type = $(blocks["list"][i].elmt).attr("type");
            if (html_block_names.indexOf(block_type) > -1) {
                var html = $(blocks["list"][i].elmt).html();
                $(blocks["list"][i].elmt).after("<" + block_type + ">" + html + "</" + block_type + ">");
                $(blocks["list"][i].elmt).remove();
            }
        }
    }

    /**
     * Replacement of HTML Attr blocks.
     * @return {[type]}
     */
    function parse_html_attrs() {
        attrs = traverse_order($("#blockly_xml"), "block[type=attr]")
        for (var i = 0; i < attrs["list"].length; i++) {
            block_type = $(attrs["list"][i].elmt).parent().prop("tagName").toLowerCase();
            if (html_block_names.indexOf(block_type) > -1) {
                var attr_name = $(attrs["list"][i].elmt).find("field[name=attr_name]").html();
                var attr_value = $(attrs["list"][i].elmt).find("field[name=attr_value]").html();
                var block = $(attrs["list"][i].elmt).parent();
                block.attr(attr_name, attr_value)
                $(attrs["list"][i].elmt).remove();
            }
        }
    }


    function parse() {
        var stages = [
            parse_nexts,
            parse_statements,
            parse_html_texts,
            parse_html_tags,
            parse_html_attrs
        ]

        for (var i = 0; i < stages.length; i++){
            stages[i]();
        }
    }

    parse();


    </script>
</body>

</html>
